<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standoff Market</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #1b1b1b; color: white; font-family: 'Exo 2', sans-serif; }
        .rarity-arcane { border-bottom: 3px solid #ff0000; background: linear-gradient(180deg, #2b2b2b 0%, #3a1a1a 100%); }
        .rarity-legendary { border-bottom: 3px solid #e91e63; background: linear-gradient(180deg, #2b2b2b 0%, #3a1a2a 100%); }
        .rarity-epic { border-bottom: 3px solid #9c27b0; }
        .rarity-common { border-bottom: 3px solid #b0c3d9; }
        .skin-card { transition: transform 0.2s; }
        .skin-card:active { transform: scale(0.95); }
        /* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader { border: 4px solid #333; border-top: 4px solid #eab308; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold tracking-widest text-yellow-500">MARKET <span class="text-white">v2</span></h1>
        <div class="bg-gray-800 px-3 py-1 rounded-lg text-sm text-green-400 font-mono">
            Balance: <span id="balance">...</span> ‚ÇΩ
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
        <button onclick="loadSkins()" class="bg-yellow-500 text-black px-4 py-2 rounded-lg font-bold text-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="bg-gray-800 px-4 py-2 rounded-lg text-sm">–ù–æ–∂–∏</button>
        <button class="bg-gray-800 px-4 py-2 rounded-lg text-sm">AWP</button>
    </div>

    <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div id="loading" class="loader"></div>
    <div id="skins-grid" class="grid grid-cols-2 gap-4 pb-20 hidden">
        <!-- –°–∫–∏–Ω—ã –¥–æ–±–∞–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>
    
    <div id="error-msg" class="text-yellow-500 text-center text-sm hidden mt-4"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#1b1b1b');

        // ==========================================
        // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
        // ==========================================
        
        // 1. –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –æ—Ç Ngrok (https://....ngrok-free.app)
        // –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—à—å –ª–æ–∫–∞–ª—å–Ω–æ –±–µ–∑ ngrok, –æ—Å—Ç–∞–≤—å http://127.0.0.1:8000 (–Ω–æ –≤ Telegram —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç)
        const API_URL = "https://unosculated-tactually-marisela.ngrok-free.dev"; 

        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç)
        const DEMO_SKINS = [
            { id: 1, name: "Demo | Karambit", price: 5000, image_url: "https://files.cults3d.com/uploaders/14660340/illustration-file/a85d3b6f-7023-4560-b8c7-434079815049/Karambit_Gold_render.jpg" },
            { id: 2, name: "Demo | AWP", price: 2000, image_url: "https://i.pinimg.com/736x/8e/82/33/8e8233f2292f7637840d02dc296339d9.jpg" },
        ];

        // ==========================================
        // üöÄ –õ–û–ì–ò–ö–ê
        // ==========================================

        const grid = document.getElementById('skins-grid');
        const loader = document.getElementById('loading');
        const errorDiv = document.getElementById('error-msg');
        const balanceEl = document.getElementById('balance');

        async function loadSkins() {
            grid.innerHTML = '';
            grid.classList.add('hidden');
            loader.style.display = 'block';
            errorDiv.classList.add('hidden');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≥–ª—É—à–∫—É: –µ—Å–ª–∏ URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —Å—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –¥–µ–º–æ
            if (API_URL.includes("—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞")) {
                console.log("API URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞.");
                errorDiv.innerText = "–î–µ–º–æ-—Ä–µ–∂–∏–º (–ë—ç–∫–µ–Ω–¥ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)";
                errorDiv.classList.remove('hidden');
                renderSkins(DEMO_SKINS);
                loader.style.display = 'none';
                grid.classList.remove('hidden');
                return;
            }

            try {
                // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch(`${API_URL}/market/all`);
                if (!response.ok) throw new Error("Server Error");
                const skins = await response.json();
                
                renderSkins(skins);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", e);
                // 2. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ (—Å–µ—Ä–≤–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                errorDiv.innerText = "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∫–∞–∑–∞–Ω –î–µ–º–æ-—Ä–µ–∂–∏–º.";
                errorDiv.classList.remove('hidden');
                renderSkins(DEMO_SKINS);
            } finally {
                loader.style.display = 'none';
                grid.classList.remove('hidden');
            }
        }

        async function loadBalance(tgId) {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞, –µ—Å–ª–∏ API URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            if (API_URL.includes("—Ç–≤–æ—è-—Å—Å—ã–ª–∫–∞")) {
                balanceEl.innerText = "Demo";
                return;
            }

            try {
                const res = await fetch(`${API_URL}/users/${tgId}`);
                const data = await res.json();
                balanceEl.innerText = data.balance;
            } catch (e) {
                balanceEl.innerText = "---";
            }
        }

        function renderSkins(skins) {
            if (skins.length === 0) {
                grid.innerHTML = '<div class="col-span-2 text-center text-gray-500">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
                return;
            }

            skins.forEach(skin => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –ø–æ —Ü–µ–Ω–µ (—É—Å–ª–æ–≤–Ω–æ)
                let rarity = 'common';
                if (skin.price > 1000) rarity = 'legendary';
                if (skin.price > 5000) rarity = 'arcane';

                const card = document.createElement('div');
                card.className = `skin-card rounded-xl p-3 relative overflow-hidden rarity-${rarity} bg-[#2b2b2b]`;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ—Ç
                const img = skin.image_url || "https://via.placeholder.com/150?text=No+Image";

                card.innerHTML = `
                    <div class="h-24 w-full bg-cover bg-center rounded-lg mb-2" style="background-image: url('${img}');"></div>
                    <div class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">${rarity}</div>
                    <div class="font-bold text-sm mb-1 truncate">${skin.name}</div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-yellow-400 font-mono text-lg">${skin.price} ‚ÇΩ</span>
                        <button onclick="buySkin(${skin.id}, '${skin.name}', ${skin.price})" class="bg-white/10 hover:bg-white/20 p-2 rounded-lg transition">
                            üõí
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function buySkin(id, name, price) {
            tg.showPopup({
                title: '–ü–æ–∫—É–ø–∫–∞',
                message: `–ö—É–ø–∏—Ç—å "${name}" –∑–∞ ${price} —Ä—É–±?`,
                buttons: [
                    {id: 'buy', type: 'default', text: '–î–∞, –∫—É–ø–∏—Ç—å'},
                    {type: 'cancel'}
                ]
            }, function(btnId) {
                if (btnId === 'buy') {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É (–æ–Ω —Å–∞–º —Å–≤—è–∂–µ—Ç—Å—è —Å API)
                    const data = { action: 'buy', skin_id: id, price: price, name: name };
                    tg.sendData(JSON.stringify(data));
                }
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadSkins();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç –¢–µ–ª–µ–≥—Ä–∞–º, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
             loadBalance(tg.initDataUnsafe.user.id);
        } else {
             balanceEl.innerText = "Demo";
        }

    </script>
</body>

</html>
